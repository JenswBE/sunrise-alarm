<template>
  <v-row align="center">
    <v-col cols="12">
      <v-dialog
        ref="dialog"
        v-model="timePicker"
        :return-value.sync="alarmTime"
        persistent
        width="500px"
      >
        <template v-slot:activator="{ on, attrs }">
          <v-text-field
            v-model="alarmTime"
            label="Time"
            prepend-icon="mdi-clock-outline"
            readonly
            :disabled="disabled"
            v-bind="attrs"
            v-on="on"
          ></v-text-field>
        </template>
        <v-time-picker
          v-if="timePicker"
          v-model="alarmTime"
          landscape
          format="24hr"
          header-color="primary"
          full-width
          :allowed-minutes="(m) => m % 5 === 0"
        >
          <v-spacer></v-spacer>
          <v-btn text color="primary" @click="timePicker = false">
            Cancel
          </v-btn>
          <v-btn text color="primary" @click="$refs.dialog.save(alarmTime)">
            OK
          </v-btn>
        </v-time-picker>
      </v-dialog>

      <v-text-field
        label="Name"
        :disabled="disabled"
        v-model="alarm.name"
      ></v-text-field>
    </v-col>
    <v-col cols="6" class="pt-0">
      <v-list-item-group v-model="alarmDays" multiple>
        <v-list-item
          v-for="day in days"
          :key="day"
          :value="day"
          :disabled="disabled"
        >
          <template v-slot:default="{ active }">
            <v-list-item-content>
              <v-list-item-title v-text="day"></v-list-item-title>
            </v-list-item-content>

            <v-list-item-action>
              <v-checkbox
                :input-value="active"
                color="primary"
                :disabled="disabled"
              ></v-checkbox>
            </v-list-item-action>
          </template>
        </v-list-item>
      </v-list-item-group>
    </v-col>
    <v-col cols="6">
      <v-row v-for="(days, name) in dayPickers" :key="name">
        <v-col>
          <v-btn
            outlined
            v-text="name"
            @click="pickDays(days)"
            :disabled="disabled"
          ></v-btn>
        </v-col>
      </v-row>
    </v-col>
    <v-col cols="6" class="text-center">
      <v-btn outlined block :disabled="disabled" @click="saveAlarm(alarm)">
        <v-icon left>mdi-alarm-check</v-icon>
        Save alarm
      </v-btn>
    </v-col>
    <v-col cols="6" class="text-center">
      <DialogConfirm
        v-model="dialogDeleteOpen"
        confirmColor="error"
        @confirm="$emit('delete-alarm')"
      />
      <v-btn
        outlined
        block
        color="error"
        :disabled="disabled"
        @click="dialogDeleteOpen = true"
      >
        <v-icon left>mdi-alarm-off</v-icon>
        Delete alarm
      </v-btn>
    </v-col>
  </v-row>
</template>

<script lang="ts">
import Vue from 'vue'
import { mapGetters } from 'vuex'
import DialogConfirm from './DialogConfirm.vue'
import { DAYS, EMPTY_ALARM, Alarm } from '../store/alarms'

export default Vue.extend({
  name: 'AlarmEdit',
  components: { DialogConfirm },

  props: {
    value: String,
  },

  data: () => ({
    alarm: {} as Alarm,
    timePicker: false,
    dialogDeleteOpen: false,
    days: DAYS,
    dayPickers: {
      None: [],
      Week: DAYS.slice(0, 5),
      Weekend: DAYS.slice(5, 7),
      All: DAYS,
    },
  }),

  watch: {
    value: {
      immediate: true,
      handler(alarmID) {
        if (alarmID) {
          this.alarm = this.getAlarm(alarmID)
        } else {
          this.alarm = EMPTY_ALARM
        }
      },
    },
  },

  computed: {
    ...mapGetters({
      getAlarm: 'alarms/getAlarm',
    }),

    disabled(): boolean {
      return !this.value
    },

    alarmTime: {
      get(): string {
        return this.$formatTime(this.alarm)
      },
      set(value: string) {
        const [hour, minute] = value.split(':')
        this.alarm.hour = Number(hour)
        this.alarm.minute = Number(minute)
      },
    },

    alarmDays: {
      get(): string[] {
        return this.alarm.days.map((dayIndex) => DAYS[dayIndex])
      },
      set(value: string[]) {
        this.alarm.days = value.map((day) => DAYS.indexOf(day))
      },
    },
  },

  methods: {
    pickDays(days: string[]) {
      this.alarmDays = days
    },

    async saveAlarm(alarm: Alarm) {
      // Restore unmananage data
      const old_alarm = this.getAlarm(alarm.id)
      alarm.enabled = old_alarm.enabled
      alarm.skip_next = old_alarm.skip_next

      // Call srv-config
      this.$axios
        .put(`/alarms/${alarm.id}`, alarm)
        .then(() => {
          this.$store.commit('alarms/UPSERT_ALARM', alarm)
          this.$store.commit('general/SET_ALERT', {
            type: 'success',
            message: 'Alarm successfully saved',
          })
        })
        .catch((e: any) => {
          const msg = `Unable to save alarm: ${e.message}`
          this.$store.commit('general/SET_ALERT', {
            type: 'error',
            message: msg,
          })
        })
        .finally(() => this.$scrollToTop())
    },
  },
})
</script>
